title;text
Работа с блочными устройствами и логическими разделами в Linux;
Общие положения
Классификация устройств
Символьные устройства
Символьное устройство - это такое устройство, к которому можно обращаться как к потоку байтов (так же как к файлу); драйвер символьного устройства отвечает за реализацию такого поведения. Такой драйвер обычно, по крайней мере, поддерживает системные вызовы open, close, read и write. Текстовый экран (/dev/console) и последовательные порты (/dev/ttyS0 и подобные) являются примерами символьных устройств, так как они хорошо представлены абстракцией потока. Для обращения к символьным устройствам используют узлы (node) файловой системы, такие как /dev/tty1 и /dev/lp0. Единственное важное отличие между символьными устройствами и обычными файлами - вы всегда можете двигаться вперед и назад в обычном файле, в то время как большинство символьных устройств - это только каналы данных, к которым вы можете обращаться только последовательно.

Блочные устройства
Блочное устройство – это общий термин для обозначения устройства хранения данных, которое считывает или записывает данные в блоках определенного размера. Этот термин относится почти к каждому типу энергонезависимой памяти, в том числе к жестким дискам (HDD), твердотельным накопителям (SSD), флэш-памяти и т.д. Блочное устройство – это физическое устройство, на котором записывается файловая система. Файловая система, в свою очередь, определяет схему (разметку). В большинстве систем Unix блочное устройство может поддерживать только операции ввода-вывода, которые передают один или более целых блоков, обычно равных 512 байт (или большей степени числа два). Linux, однако, разрешает приложению читать и писать в блочное устройство, так же как и в символьное устройство - это позволяет передавать любое число байт за раз. В результате, блочные и символьные устройства отличаются только способом управления данными внутри ядра и, соответственно, программным интерфейсом в ядре/драйвере. Как и символьное устройство, каждое блочное устройство доступно через узел файловой системы, так что различия между ними не видны пользователю. Блочные драйверы имеют интерфейс для ядра полностью отличный от символьных устройств.

Именования дисковых устройств в Linux
В Linux все отображается в файловом виде, в том числе и устройства. Все подключенные к операционной системе Linux устройства размещаются в каталоге /dev/ здесь вы найдете жесткие диски, флешки, одним словом, все внешние и внутренние устройства.

Жесткие диски имеют особенные названия. В зависимости от интерфейса, через который подключён жёсткий диск, название может начинаться на:

sd - устройство, подключённое по SCSI (SAS, SATA и т.д.);
hd - устройство ATA (IDE);
vd - виртуальное устройство;
Примечание

На данный момент часто встречаются SCSI устройства, подключенные через SAS и SATA интерфейс. Например диск подключенный к первому интерфейсу будет отображаться как /dev/sda, а первый раздел на нем /dev/sda1 (это дисковая партиция).

Утилиты для работы с системами хранения
lsblk
Утилита lsblk позволяет отобразить информацию о блочных устройствах. Конкретные возможности утилиты зависят от установленной версии, но в целом команда lsblk может предоставить информацию о самом устройстве, разделении диска и файловой системе.

Без аргументов lsblk выведет имя устройства, его размер, права доступа, тип (диск или раздел), точку монтирования и сообщит, является ли устройство съемным (столбец RM).

findmnt
Чтобы отобразить параметры монтирования, использованные для конкретного монтирования, используйте команду findmnt. Без указания опций собирает информацию о текущем состоянии подключенных файловых систем.

Примечание

Точка монтирования – это просто каталог, в котором будет смонтирована файловая система.

rescan-scsi.bash
Скрипт для перечитывания информации о подключенных SCSI устройствах без необходимости перезагрузки ОС.

Пример


#!/usr/bin/env bash
# Copyright (C) 2019 Dmitriy Prigoda <deamon.none@gmail.com> 
# This script is free software: Everyone is permitted to copy and distribute verbatim copies of 
# the GNU General Public License as published by the Free Software Foundation, either version 3
# of the License, but changing it is not allowed.
# Scan new SCSI device.

if [[ $EUID -ne 0 ]]; then
   echo "[-] This script must be run as root" 1>&2
   exit 1
fi

BUSSES=$(ls -l /sys/class/scsi_host/host* | grep -o host[0-9] | uniq)
DEVICES=$(ls /sys/class/scsi_device/)

# Перечитывает информацию об уже подключенных устройствах (полезно когда диск был расширен)
for DEVICE in ${DEVICES}
do
  echo "RESCANNING DEVICE : ${DEVICE}"
  echo 1 > /sys/class/scsi_device/${DEVICE}/device/rescan
done

# Перечитывает информацию об новых подключенных устройствах (полезно когда добавлен новый диск)
for BUS in ${BUSSES}
do
   echo "RESCANNING HOST BUS : ${BUS}"
   echo "- - -" > /sys/class/scsi_host/${BUS}/scan
done
#End
exit 0
Внимание

Скрипт не является частью базового дистрибутива. Добавлен в типовой шаблон.

Увеличение дискового пространства
Поиск новых дисков
Для обнаружения новых дисков необходимо запустить скрипт rescan-scsi.bash

Проверить доступность нового диска командой

Команда


lsblk
Пример


# lsblk
NAME                       MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda                          8:0    0   50G  0 disk
├─sda1                       8:1    0  950M  0 part /boot
├─sda2                       8:2    0 15.5G  0 part
│ ├─VG_SoftWare-usr        253:0    0 10.3G  0 lvm  /usr
│ └─VG_SoftWare-sys_backup 253:1    0  5.2G  0 lvm  /sys_backup
├─sda3                       8:3    0   15G  0 part
│ ├─VG_OtherData-opt       253:2    0 10.3G  0 lvm  /opt
│ └─VG_OtherData-home      253:4    0  4.7G  0 lvm  /home
├─sda4                       8:4    0    1K  0 part
├─sda5                       8:5    0  9.8G  0 part
│ ├─VG_SystemData-tmp      253:3    0  4.7G  0 lvm  /tmp
│ └─VG_SystemData-var      253:5    0   75G  0 lvm  /var
└─sda6                       8:6    0  3.7G  0 part /
sdb                          8:16   0  100G  0 disk
sr0                         11:0    1 1024M  0 rom
В данном примере новый диск /dev/sdb, размером 100G.

Создание новой раздела на диске
На новом диске необходимо создать новый раздел командой
Команда


pvcreate <диск><раздел>
Пример


# pvcreate /dev/sdb1
Physical volume "/dev/sdb1" successfully created
Для проверки использовать
Команда


lsblk
Пример


# lsblk
NAME                       MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda                          8:0    0   50G  0 disk
├─sda1                       8:1    0  950M  0 part /boot
├─sda2                       8:2    0 15.5G  0 part
│ ├─VG_SoftWare-usr        253:0    0 10.3G  0 lvm  /usr
│ └─VG_SoftWare-sys_backup 253:1    0  5.2G  0 lvm  /sys_backup
├─sda3                       8:3    0   15G  0 part
│ ├─VG_OtherData-opt       253:2    0 10.3G  0 lvm  /opt
│ └─VG_OtherData-home      253:4    0  4.7G  0 lvm  /home
├─sda4                       8:4    0    1K  0 part
├─sda5                       8:5    0  9.8G  0 part
│ ├─VG_SystemData-tmp      253:3    0  4.7G  0 lvm  /tmp
│ └─VG_SystemData-var      253:5    0   75G  0 lvm  /var
└─sda6                       8:6    0  3.7G  0 part /
sdb                          8:16   0  100G  0 disk
└─sdb1                       8:17   0  100G  0 part
sr0                         11:0    1 1024M  0 rom
Расширение группы томов
Для получения информации об доступных группах томов необходимо воспользоваться командами
Команда


vgscan
Пример


# vgscan
   Found volume group "VG_SystemData" using metadata type lvm2
   Found volume group "VG_OtherData" using metadata type lvm2
   Found volume group "VG_SoftWare" using metadata type lvm2
Команда


vgs <Имя группы>
Пример


# vgs VG_SystemData
  VG            #PV #LV #SN Attr   VSize   VFree
  VG_SystemData   1   2   0 wz--n- 15.00g  0
Примечание

В группе VG_SystemData два логических тома, для расширения var необходимо в эту группу добавить ранее созданный раздел на новом диске.

Добавление раздела осуществляется командой
Команда


vgextend <Имя группы> <раздел>
Пример


# vgextend VG_SystemData /dev/sdb1
Проверяем результат
Команда


vgs <Имя группы>
Пример


# vgs VG_SystemData
  VG            #PV #LV #SN Attr   VSize   VFree
  VG_SystemData   2   2   0 wz--n- 15.00g  100.00g
Увеличения объема целевого логического тома
Для получения информации об доступных логических томах необходимо воспользоваться командами
Команда


lvscan
Пример


# lvscan
  ACTIVE            '/dev/VG_SystemData/tmp' [<4.66 GiB] inherit
  ACTIVE            '/dev/VG_SystemData/var' [15.00 GiB] inherit
  ACTIVE            '/dev/VG_OtherData/opt' [<10.29 GiB] inherit
  ACTIVE            '/dev/VG_OtherData/home' [<4.66 GiB] inherit
  ACTIVE            '/dev/VG_SoftWare/sys_backup' [5.15 GiB] inherit
  ACTIVE            '/dev/VG_SoftWare/usr' [<10.29 GiB] inherit
Команда


lvs <Логический том>
Пример


# lvs /dev/VG_SystemData/var
  LV   VG            Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  var  VG_SystemData -wi-ao---- 15.00g
Расширение осуществляется командой
Команда


lvextend <объем> <LV>

Процентное соотношение
Пример


# lvextend -l +100%FREE /dev/VG_SystemData/var
  Extending logical volume testlv to 115.00 GB
  Logical volume testlv successfully resized

Фиксированное до определенного объема

Фиксированное на определенный объем
Проверяем результат
Команда


lvs <Логический том>
Пример


# lvs /dev/VG_SystemData/var
  LV   VG            Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  var  VG_SystemData -wi-ao---- 115.00g
Изменение размера файловой системы
Для расширения файловой системы необходимо выполнить следующие команды в зависимости от файловой системы.

Информация

resize2fs </mount/point> - для EXT2, EXT3, EXT4
xfs_growfs </mount/point> -D - для XFS
Найти точку монтирования
Команда


findmnt -T <Каталог монтирования>
Пример


# findmnt -T /var
  TARGET SOURCE                        FSTYPE OPTIONS
  /var   /dev/mapper/VG_SystemData-var ext4   rw,relatime,seclabel
Расширить ФС

Для EXT2, EXT3, EXT4
Команда


resize2fs <Точка монтирования>
Пример


# resize2fs /dev/mapper/VG_SystemData-var

Для XFS
Внимание

XFS - является несжимаемой файловой системой, после ее расширения перераспределение ресурсов за счет нее не получится произвести.

Проверяем результат
Команда


lsblk
Пример


# lsblk
NAME                       MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda                          8:0    0   50G  0 disk
├─sda1                       8:1    0  950M  0 part /boot
├─sda2                       8:2    0 15.5G  0 part
│ ├─VG_SoftWare-usr        253:0    0 10.3G  0 lvm  /usr
│ └─VG_SoftWare-sys_backup 253:1    0  5.2G  0 lvm  /sys_backup
├─sda3                       8:3    0   15G  0 part
│ ├─VG_OtherData-opt       253:2    0 10.3G  0 lvm  /opt
│ └─VG_OtherData-home      253:4    0  4.7G  0 lvm  /home
├─sda4                       8:4    0    1K  0 part
├─sda5                       8:5    0  9.8G  0 part
│ ├─VG_SystemData-tmp      253:3    0  4.7G  0 lvm  /tmp
│ └─VG_SystemData-var      253:5    0  115G  0 lvm  /var
└─sda6                       8:6    0  3.7G  0 part /
sdb                          8:16   0  100G  0 disk
└─sdb1                       8:17   0  100G  0 part
  └─VG_SystemData-var      253:5    0  115G  0 lvm  /var
sr0                         11:0    1 1024M  0 rom
WebUI
С помощью WebUI Cockpit таж можно управлять LVM томами и дисками. Подробно написано тут.

Диагностика
Для получения информации и ошибках LV, необходимо выполнить команду
Команда


lvs --all --options +devices
Пример


# lvs --all --options +devices
   /dev/sdb: open failed: No such device or address
   /dev/sdb: open failed: No such device or address
   WARNING: Couldn't find device with uuid 42B7bu-YCMp-CEVD-CmKH-2rk6-fiO9-z1lf4s.
   WARNING: VG vg is missing PV 42B7bu-YCMp-CEVD-CmKH-2rk6-fiO9-z1lf4s (last written to /dev/sdb1).
   WARNING: Couldn't find all devices for LV vg/linear while checking used and assumed devices.
   WARNING: Couldn't find all devices for LV vg/stripe while checking used and assumed devices.
   LV     VG Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert Devices
   linear vg -wi-a---p- 20.00g                                                     [unknown](0)
   stripe vg -wi-a---p- 20.00g                                                     [unknown](5120),/dev/sdc1(0)
Для получения информации и ошибках VG, необходимо выполнить команду
Команда


vgs --all --options +devices
Пример


# vgs --all --options +devices
   /dev/sdb: open failed: No such device or address
   /dev/sdb: open failed: No such device or address
   WARNING: Couldn't find device with uuid 42B7bu-YCMp-CEVD-CmKH-2rk6-fiO9-z1lf4s.
   WARNING: VG vg is missing PV 42B7bu-YCMp-CEVD-CmKH-2rk6-fiO9-z1lf4s (last written to /dev/sdb1).
   WARNING: Couldn't find all devices for LV vg/linear while checking used and assumed devices.
   WARNING: Couldn't find all devices for LV vg/stripe while checking used and assumed devices.
   VG #PV #LV #SN Attr   VSize  VFree  Devices
   vg   2   2   0 wz-pn- <3.64t <3.60t [unknown](0)
   vg   2   2   0 wz-pn- <3.64t <3.60t [unknown](5120),/dev/sdc1(0)
Для получения информации об LVM необходимо выполнить команду
Команда


dmsetup info --columns
Пример


# dmsetup info --columns
  Name                   Maj Min Stat Open Targ Event  UUID
  VG_SystemData-tmp      253   3 L--w    1    1      0 LVM-hIdFDibzFgB3EcoMp4WdCOQTZaY7eqan3cCeAyBAFF60cVsu2MJf0OJMw3oBxrPK
  VG_OtherData-home      253   4 L--w    1    1      0 LVM-DN2aPyPUsETJWUq3Wl17lUCS1k03u5wG2yb0MfKGk4HvBGdj5alOcfjSh98aBsSM
  VG_SystemData-var      253   5 L--w    1    2      0 LVM-hIdFDibzFgB3EcoMp4WdCOQTZaY7eqanepBk1wyfFbF05RhId3Vsu8OnZ5HWKcfc
  VG_SoftWare-usr        253   0 L--w    1    1      0 LVM-ngcivWexAJrN0Xc2mn0PWYptASVVb26s3WeVgXQYWY9HDoMuG4AwMtv5m8r7TmUS
  VG_OtherData-opt       253   2 L--w    1    1      0 LVM-DN2aPyPUsETJWUq3Wl17lUCS1k03u5wG7WIBLgpH0UnUuaQVC38OqwtxXIL9lofS
  VG_SoftWare-sys_backup 253   1 L--w    1    1      0 LVM-ngcivWexAJrN0Xc2mn0PWYptASVVb26sZbbnX4j0LeInJoTVV5q4Gtczm6GVoDYY